<HTML>

<STYLE>

body {
	font-family: "Realbook", Arial, sans-serif ;
}

.tune {
}

.composer {
	font-size: 1.25em ;
	width: 50% ;
}

.style {
	font-size: 1.25em ;
	text-align: right ;
	width: 50% ;
}

.title {
	font-size: 1.75em ;
	text-align: center ;
}

.label {
	font-size: 1.25em ;
}

.description {
	font-size: 1.25em ;
}

.prebar {
    border-left: 4px solid black ;
    width: 1px ;
}

.prebar2 {
    border-left: 9px double black ;
    width: 1px ;
}

.postbar {
    border-right: 4px solid black ;
    width: 1px ;
}

.postbar2 {
    border-right: 9px double black ;
    width: 1px ;
}

.q {
   font-size: 0.75em ;
}

.chord {
	font-size: 3em ;
	// font-weight: bold ;
}

.comment {
}

th {
	text-aligh: left ;
}

.cols {
	width: 12em ;
}

@font-face {
	font-family: Realbook ;
	src: url(realbook-webfont.woff) ;
}

</STYLE>


<BODY>

<SCRIPT>
/* A tune is composed of:
	- title:
	- composer:
	- style:
	- key:
	- sections: A list of section that build up the tune.

Each section can contain:
	- label: Section label (A, B, I, ...)
	- description: Comment to be displayed at the top of the section, next to the label
	- repeat: number of times the section should be repeated
	- bars: A list of bars

Each bar can contain:
	- coda, segno?
	- repeat_last: repeat last bar (1, %) or last two bars (2, %%).
	- meter: Time signature for the bar (4/4). Carries on from the last bar if not specified.
	- beats: number of beats in the bar. Carries on from the last bar if not specified.
	- chords: A list of chords

Each chord can contain:
	- name:
	- beats: Number of beats for the chord. If not specified, remaining time is divided evenly between chords.

*/


var beats_per_bar = 4 ;

/*
var tune =
{ "composer": "Coltrane John", "key": "C#-", "style": "Slow Swing", "title": "Equinox", "sections": [
  { "bars": [
    { "meter": "4/4", "chords": [
      { "name": "C#-7" }
    ] },
    { "repeat_last": "1" },
    { "repeat_last": "1" },
    { "repeat_last": "1" },
    { "chords": [
      { "name": "F#-7" }
    ] },
    { "repeat_last": "1" },
    { "chords": [
      { "name": "C#-7" }
    ] },
    { "repeat_last": "1" },
    { "chords": [
      { "name": "A7" }
    ] },
    { "chords": [
      { "name": "G#7" }
    ] },
    { "chords": [
      { "name": "C#-7" }
    ] },
    { "repeat_last": "1" }
  ] }
] } ;
*/

var tune =
{ "composer": "Jones Isham", "key": "Bb", "style": "Medium Swing", "title": "There Is No Greater Love", "sections": [
  { "description": "head", "repeat": "1", label: "A", "bars": [
    { "meter": "4/4", "chords": [
      { "name": "Bb^7" }
    ] },
    { "chords": [
      { "name": "Eb7" }
    ] },
    { "chords": [
      { "name": "Ab7" }
    ] },
    { "chords": [
      { "name": "G7" }
    ] },
    ],
    "endings": [ { "no": "1", "bars": [
      { "chords": [
        { "name": "C7" }
      ] },
      { "repeat_last": "1" },
      { "chords": [
        { "name": "C-7" }
      ] },
      { "chords": [
        { "name": "F7" }
      ] }
    ] },
    { "no": "2", "bars": [
      { "chords": [
        { "name": "C7" }
      ] },
      { "chords": [
        { "beats": "2", "name": "C-7" },
        { "beats": "2", "name": "F7" }
      ] },
      { "chords": [
        { "name": "Bb6" }
      ] },
      { "repeat_last": "1" }
    ] }
  ] },
 { "label": "B", "bars": [
    { "chords": [
      { "beats": "2", "name": "Ah7" },
      { "beats": "2", "name": "D7b9" }
    ] },
    { "chords": [
      { "name": "G-6" }
    ] },
    { "chords": [
      { "beats": "2", "name": "Ah7" },
      { "beats": "2", "name": "D7b9" }
    ] },
    { "chords": [
      { "name": "G-6" }
    ] },
    { "chords": [
      { "beats": "2", "name": "Ah7" },
      { "beats": "2", "name": "D7b9" }
    ] },
    { "chords": [
      { "name": "G-7" }
    ] },
    { "chords": [
      { "name": "C7" }
    ] },
    { "chords": [
      { "name": "F7" }
    ] }
  ] },
  { "label": "A", "bars": [
    { "chords": [
      { "name": "Bb^7" }
    ] },
    { "chords": [
      { "name": "Eb7" }
    ] },
    { "chords": [
      { "name": "Ab7" }
    ] },
    { "chords": [
      { "name": "G7" }
    ] },
    { "chords": [
      { "name": "C7" }
    ] },
    { "chords": [
      { "beats": "2", "name": "C-7" },
      { "beats": "2", "name": "F7" }
    ] },
    { "chords": [
      { "name": "Bb6" }
    ] },
    { "chords": [
      { "beats": "2", "name": "C-7" },
      { "beats": "2", "name": "F7" }
    ] }
  ] }
] } ;


var tbl = header(document.body, tune) ;

var col = 0 ;
for (var i in tune.sections){
	var s = tune.sections[i] ;
	section(tbl, s) ;
}


function header(parent, tune){
	var tbl = document.createElement('table') ;
    parent.appendChild(tbl) ;
	tbl.setAttribute("border", "1") ;
	tbl.className = "tune" ;

	var tr = tbl.insertRow() ;
	var td = tr.insertCell() ;
	td.setAttribute("colspan", 4) ;
	td.className = "composer" ;
	td.innerHTML = tune.composer ;
	td = tr.insertCell() ;
	td.setAttribute("colspan", 5) ;
	td.className = "style" ;
	td.innerHTML = tune.style ;

	var tr = tbl.insertRow() ;
	var td = tr.insertCell() ;
	td.setAttribute("colspan", 9) ;
	td.className = "title" ;
	td.innerHTML = tune.title + "<BR/>" ;

    return tbl ;
}


/* Each section is a table that is 9 columns wide (4 prebars, 4 bars, 1 postbar)
*/
function section(tbl, section){
	var repeat = (section.repeat ? section.repeat : 0) ;
    var label = fix_label(section.label) ;
	var description = (section.description ? section.description : "") ;

	// We go through the bars of the section.
	var top_tr, mid_tr, bot_tr ;
	if ((section.bars)&&(section.bars.length > 0)){
		for (var i = 0 ; i < section.bars.length ; i++){
			var first = (i == 0 ? true : false) ;
			var last = (i == (section.bars.length - 1) ? true : false) ;

			if ((col == 0)||((first)&&(label))){
            	top_tr = tbl.insertRow() ;
            	mid_tr = tbl.insertRow() ;
            	bot_tr = tbl.insertRow() ;
			}

			if (first){
            	prebar(top_tr, mid_tr, bot_tr, label, repeat) ;
            	bar(top_tr, mid_tr, bot_tr, section.bars[i], description) ;
            }
			else {
            	prebar(top_tr, mid_tr, bot_tr, "", 0) ;
            	bar(top_tr, mid_tr, bot_tr, section.bars[i], "") ;
			}

			col++ ;
			if (col == 4){
				if (last){
					if (repeat){
						if (section.endings){
							postbar(top_tr, mid_tr, bot_tr , "", 0) ;
						}
						else {
                        	postbar(top_tr, mid_tr, bot_tr , "", 1) ;
						}
					}
					else {
 						postbar(top_tr, mid_tr, bot_tr , label, 0) ;
					}
				}
				else {
                   postbar(top_tr, mid_tr, bot_tr , "", 0) ;
				}

				col = 0 ;
			}
		}
	}


	// TODO: Go through the endings


	/*
	// Display section label and description
    var tr = tbl.insertRow() ;
	var td = tr.insertCell() ;
	td.setAttribute("colspan", 4) ;

	td.innerHTML = "<span class='label'>" + label + "</span> </span class='description'>" + description + "</span>" ;


	var n = 0 ;
	for (var i in section.bars){
		var b = section.bars[i] ;
		prebar(tr, label, repeat) ;
		bar(tr, section, b, n) ;
		n++ ;
		if (n == 4){
            tr = tbl.insertRow() ;
			n = 0 ;
		}
	}
	*/

}


function fix_label(label){
	label = (label ? label.substring(0, 1).toUpperCase() : "") ;
	switch (label) {
		case "A": return "&#x0391;" ;
		case "B": return "&#x0392;" ;
		case "C": return "&#x0393;" ;
		case "D": return "&#x0394;" ;
		case "E": return "&#x0395;" ;
		case "F": return "&#x0396;" ;
		default : return label ;
	}
}


function prebar(top_tr, mid_tr, bot_tr, label, repeat){
	var td = top_tr.insertCell() ;
	td.className = "label" ;
	td.innerHTML = (label ? label : "&nbsp;") ;

    td = mid_tr.insertCell() ;
    if (label){
		td.className = "prebar2" ;
    }
    else {
	    td.className = "prebar" ;
    }
    if (repeat){
		td.innerHTML = "<span class='chord'>:</span>" ;
    }

 	td = bot_tr.insertCell() ; // empty cell
 	td.className = "comment" ;
 	// td.innerHTML = "&nbsp;" ;
}


function postbar(top_tr, mid_tr, bot_tr, label, repeat){
	var td = top_tr.insertCell() ;

    td = mid_tr.insertCell() ;
    if (label){
		td.className = "postbar2" ;
    }
    else {
	    td.className = "postbar" ;
    }
    if (repeat){
		td.innerHTML = "<span class='chord'>:</span>" ;
    }

 	td = bot_tr.insertCell() ; // empty cell
}


/* A bar is a table, that consists, for now, of two rows:
	- Chord names
	- Beat staff
*/
function bar(top_tr, mid_tr, bot_tr, bar, description){
	if (bar.beats > 0){
		beats_per_bar = bar.beats ;
	}

	var td = top_tr.insertCell() ;
	if (description){
		td.innerHTML = "<span class='description'>" + description + "</span>" ;
	}

	td = mid_tr.insertCell() ;
	td.className = "cols" ;
	var tbl = document.createElement('table') ;
	td.appendChild(tbl) ;
    tbl.setAttribute("border", "1") ;
    tbl.style.width = "100%" ;

    // Insert the guide row
    var tr = tbl.insertRow() ;
	for (var i = 0 ; i < beats_per_bar ; i++){
		td = tr.insertCell() ;
		td.height = "1px" ;
		td.style.width = "25%" ;
	}

    tr = tbl.insertRow() ;
	if (bar.repeat_last == 1){
		td = tr.insertCell() ;
		td.setAttribute('colspan', beats_per_bar) ;
		td.align = 'center' ;
		td.innerHTML = "<span class='q'>%</span>" ;
	}
	else {
		for (var i in bar.chords){
			var c = bar.chords[i] ;
			var cols = (c.beats > 0 ? c.beats : beats_per_bar) ;
			td = tr.insertCell() ;
			td.setAttribute('colspan', cols) ;
			td.className = "chord" ;
			chord(td, c) ;
		}
	}

	td = bot_tr.insertCell() ;
	td.className = "comment" ;

	/*
	for (var i = 0 ; i < beats_per_bar ; i++){
		td = tr.insertCell() ;
		td.innerHTML = "&nbsp;&nbsp;" ;
		td.height = "1px" ;
	}

	if (last){
		td = tr.insertCell() ;
		td.className = "prebar" ;
		td.innerHTML = "&#119040;" ;
	}
	*/
}


function chord(parent, chord){
	var c = chord.name ;
	var matches = c.match(/^([_A-G])(b|#|)(.*)$/) ;
	var acc = matches[2] ;
	var rest = matches[3] ;
	acc = acc.replace("#", "&#x03B3;") ;
	acc = acc.replace("b", "&#x03B2;") ;

    rest = rest.replace("#", "&#x03B3;") ;
	rest = rest.replace("b", "<sup>&#x03B2;</sup>") ;

	if (matches.length > 0){
		parent.innerHTML = matches[1] + acc + "<span class='q'><sup>" + rest + "</sup></span>" ;
	}
	else {
		parent.innerHTML = chord.name ;
	}
}
</SCRIPT>




















